<?php
	require_once("../../../../wp-blog-header.php");
	require_once( realpath( dirname(__FILE__) . "/../dbconfig.php" ) );
	global $wpdb;

	if(isset($_GET['chk'])){

		//check if database exists, create database
		if(isset($_GET['name'])){
			$gallery = $_GET['name'];
			$gallery_name = $wpdb->prefix . $gallery;
			if($wpdb->get_var("SHOW TABLES LIKE '$gallery_name'") != $gallery_name) {
				$query = "CREATE TABLE $gallery_name (
					id mediumint(9) NOT NULL AUTO_INCREMENT PRIMARY KEY,
					KID VARCHAR(45) NOT NULL,
					url VARCHAR(10000) DEFAULT '' NOT NULL,
					thumb VARCHAR(10000) DEFAULT '' NOT NULL,
					title VARCHAR(999) NOT NULL
					);";
				$wpdb->query($query);
				$wpdb->insert(
					$wpdb->prefix . "koragallery",
					array(
						"title" => $gallery
						),
					array(
						'%s'
						) 
				);
			}

			//check if object is already in gallery
			$gallery_name = $_GET['name'];
			$gallery_name = $wpdb->prefix . $gallery_name;
			$kid = $_GET['chk'];
			$query = "SELECT * FROM $gallery_name where KID= '$kid'";
			
			if(empty($wpdb->get_results($query))){
		/* connect to database*/
	 $mysql_hostname = kordat_dbhostname;
     $mysql_user = kordat_dbhostuser;
     $mysql_database = kordat_dbselectname;
	 $mysql_password = kordat_dbhostpass;
	   $bd = new mysqli($mysql_hostname, $mysql_user, $mysql_password, $mysql_database);
     if ($bd->connect_error) {
      die("Connection failed: " . $bd->connect_error);
     }
		$dbproj = get_option('kordat_dbproj');
       $dbscheme = get_option('kordat_dbscheme');
       $dbtoken = get_option('kordat_dbtoken');
           //var_dump($dbproj);
           // var_dump($dbscheme);
            //var_dump($dbtoken);
       // if (count(sids) > 0) {
            $query_sid_pid = "SELECT schemeid,pid FROM scheme";
            $stmt = $bd->prepare($query_sid_pid) ;
                        $stmt->execute();
                        $stmt->bind_result($sids,$pids);
                        $sid_pid_token = array();
                        
                        while($stmt->fetch()){
                            $sid = $sids;
                            $pid = $pids;
                            //echo $sid." ".$pid."<br>";
                             if (in_array($sid, $dbscheme) && in_array($pid, $dbproj)){
                                $pos = array_search($pid, $dbproj);
                                 $val = $sid."-".$pid."-".$dbtoken[$pos];
                                 array_push($sid_pid_token,$val);
                            }
                        }
            $stmt->close();
        //    var_dump($sid_pid_token);
       // }
			
				//$token = get_option('kordat_dbtoken');
				//$pid = get_option('kordat_dbproj');
				//$sid = get_option('kordat_dbscheme');
			//$user = get_option('kordat_dbuser');
			$user = kordat_dbuser;
			//$pass = get_option('kordat_dbpass');
			$pass = kordat_dbpass;
				$query = "KID,=,".$kid;
				$restful_url = get_option('kordat_dbapi') . KORA_PLUGIN_RESTFUL_SUBPATH;
				$fields = 'ALL';
				$display='plugin';

			/*	$scheme_proj_token=get_option('kordat_scheme_dbproj_token');
				//	echo $scheme_proj_token[0].$scheme_proj_token[1].$scheme_proj_token[2];
				if(is_array($scheme_proj_token)){
					$_limit=sizeof($scheme_proj_token);
					for($i=0;$i<$_limit;$i=$i+3){
						if($i==0){
							///build url
							$url = array($restful_url.'?request=GET&pid='.$scheme_proj_token[$i+1].'&sid='.$scheme_proj_token[$i].'&token='.$scheme_proj_token[$i+2].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query));
							//$url = $restful_url.'?request=GE T&pid='.$pid[0].'&sid='.$sid[0].'&token='.$token[0].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query);
			
						}
						else{
							$url1 = $restful_url.'?request=GET&pid='.$scheme_proj_token[$i+1].'&sid='.$scheme_proj_token[$i].'&token='.$scheme_proj_token[$i+2].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query);
							array_push($url,$url1);
						}
					}
				}*/
				$url =array();
             if (is_array($sid_pid_token)){
                foreach($sid_pid_token as $vals){
                    $val = explode("-",$vals);
                    //var_dump($val);
                //    if ($val[0] == $_POST['id_scheme']){
                        $url1 = $restful_url.'?request=GET&pid='.$val[1].'&sid='.$val[0].'&token='.$val[2].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query);
                        array_push($url,$url1);
                  //  }
                }
             }
				
				$i=0;
				if(is_array($url)){
					foreach($url as $value){
						///initialize post request to KORA API using curl
						$ch = curl_init($value);
						curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
						curl_setopt($ch, CURLOPT_USERPWD, $user.':'.$pass);

						///capture results and display
						//$server_output = curl_exec($ch);
					   if($i==0){
						$server_output=array( curl_exec($ch));
					   }
					   else{
						array_push($server_output,curl_exec($ch));
					   }
					  // echo $server_output[$i];
					   
					   $i=$i+1;
					}
				}
				else{
						///initialize post request to KORA API using curl
						$ch = curl_init($url);
						curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
						curl_setopt($ch, CURLOPT_USERPWD, $user.':'.$pass);

						///capture results and display
						$server_output = curl_exec($ch);
					   
					   echo $server_output;
				}
		
			
				if(is_array($server_output)){
					foreach($server_output as $value){
						//gets url of image
						if($value == ''){
							//echo "Search Returned No Results, Try Again";
						}
						else{
							$xpath = new DOMXPath(@DOMDocument::loadHTML($value));
							$thumb_src = $xpath->evaluate("string(//img/@src)");
							$src = str_replace("thumbs/", "", $thumb_src);
							
							//Get KID from HTML
						//	$kid = $xpath->evaluate("string(/html/body/div/div/div[2])");
							//$title = $xpath->evaluate("string(/html/body/div/div[3]/div[2])");
							
						}
					}
				}

				$wpdb->insert(
					$gallery_name,
					array(
						'KID' => $kid,
						'url' => "$src",
						'title' => $title,
						'thumb' => $thumb_src
					),
					array(
						'%s',
						'%s',
						'%s',
						'%s'
					)
				);
				header('HTTP/1.1 200 OK');
				echo json_encode (true);
			}
			else{
				header('HTTP/1.1 200 OK');
				echo json_encode(false);

			}
		}
	}
?>

