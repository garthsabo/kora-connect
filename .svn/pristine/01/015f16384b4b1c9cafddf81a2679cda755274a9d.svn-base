<link rel="stylesheet" type="text/css" href="kora.css">



<?php
    //where is close icon? or create?
	require_once( realpath( dirname(__FILE__) . "/../../../wp-includes/wp-db.php" ) );
	require_once( realpath( dirname(__FILE__) . "/../../../wp-blog-header.php"));
	require_once( realpath( dirname(__FILE__) . "/dbconfig.php" ) );

	global $wpdb;
	define('KORA_PLUGIN_RESTFUL_SUBPATH', 'api/restful.php');
    define('KORA_PLUGIN_PATHBASE', plugin_dir_url(__FILE__));

	 /* connect to database*/
	 $mysql_hostname = kordat_dbhostname;
     $mysql_user = kordat_dbhostuser;
     $mysql_database = kordat_dbselectname;
	 $mysql_password = kordat_dbhostpass;
	// $mysql_hostname = get_option('kordat_dbhostname');
     //$mysql_user = get_option('kordat_dbhostuser');
     //$mysql_database = get_option('kordat_dbselectname');
	 //$mysql_password = get_option('kordat_dbhostpass');
	 $projector_id=get_option('kordat_dbproj');
       // var_dump( $projector_id);

	 $scheme_id=get_option('kordat_dbscheme');
	 $n=0;
	// var_dump($scheme_id);
	if (is_array($projector_id)) {
	 foreach($projector_id as $value){
		if($value !==""){
			//echo $value;
			$table[$n]="p".$value."Control";
			//echo $table[$n];
			$n=$n+1;
		}
	 }
	}

	// $table="p".$projector_id."Control";
     $bd = new mysqli($mysql_hostname, $mysql_user, $mysql_password, $mysql_database);
     if ($bd->connect_error) {
      die("Connection failed: " . $bd->connect_error);
     }

$url_plugin=$_GET['url'];

	 $i=0;
	 $query_control='';
	if (is_array($table)) {
	 foreach($table as $value){
		if($i!=0){
			$query_control.= " UNION ALL ";
		}

		$query_control .= "SELECT name,schemeid FROM $value WHERE showInResults = 1 AND schemeid in(";

		$lastScheme = end($scheme_id);
	  if (is_array($scheme_id)) {
		foreach($scheme_id as $value){
		 if($value == $lastScheme){
			 $query_control.=$value;
		 }
		 else{
			 $query_control.=$value.",";
		 }

	   }
	  }
		$query_control.=")";
			$i=$i+1;
	 }
	}

	 $query_control.="  ORDER BY name ASC;";
     //create scheme information query
     $query_scheme .= "SELECT schemeid, pid, schemeName, description FROM scheme WHERE schemeid in(";
     if (is_array($scheme_id)) {
         $lastScheme = end($scheme_id);
		foreach($scheme_id as $value){
		 if($value == $lastScheme){
             $query_scheme .=$value;
		 }
		 else{
             $query_scheme .= $value.",";
         }
	   }
	  }
     $query_scheme.=")";
     $query_scheme .= " ORDER BY schemeid ASC;";
	 //var_dump($query_scheme);





	?>

<div class="form_upload">
  <form action="" method="post" id="form_search">
  <?php
    //Get all scheme infromation from db.
   $stmt = $bd->prepare($query_scheme) ;
   $stmt->execute();
   $stmt->bind_result($sid, $pid, $sname, $sdesc);
   $schemeInfo = array();

   while($stmt->fetch()){
        $schemeInfo[] = array('sid' => $sid, 'pid' => $pid, 'schemeName' => $sname, 'description' => $sdesc);
   }

   $stmt->close();

    
	echo "<p><input type='text' name = 'gallery_name' id = 'gallery_name' value = '".$_POST['gallery_name']."'placeholder='Title:'/></p>";
	echo "<p><input type='text' name = 'gallery_description' id = 'gallery_description' value = '".$_POST['gallery_description']."' placeholder='Description:'/></p>";
    // scheme id list
	echo "<p><select class='chosen_select' id = 'id_scheme' name = 'id_scheme'>";
	echo "<option value='' selected>  </option>";
	foreach ($schemeInfo as $value) {
		$id_scheme = $value['sid'];
        $name_scheme = $value['schemeName'];
        $desc_scheme = $value['description'];
        $pid_scheme = $value['pid'];
 			echo '<option value="' . $id_scheme . '"' . ($_POST['id_scheme'] == $id_scheme ? ' selected="selected"' : '') . '>' . $pid_scheme.'---'.$id_scheme.'---'.$name_scheme.'---'.$desc_scheme.'</option>';
	}
	echo "</select></p>"; ?>
                <select id='fields' class = 'array_control chosen_select' name = "controlsImage" data-placeholder="Select Image Field Name">
               <option value="default"></option>
           </select>
           <select id='fields' class = 'array_control chosen_select' name = "controlsVideo" data-placeholder="Select Video Field Name">
               <option value="default"></option>
           </select>
           <select id='fields' class = 'array_control chosen_select' name = "controlsAudio" data-placeholder="Select Audio Field Name">
               <option value="default"></option>
           </select>
    
	<?php 
    // control fields list
    echo "<p><select class='array_control chosen_select' id = 'fields' name='array_control[]' data-placeholder='Field(s): Search and select field(s) for new object(s)'   multiple onchange = 'checkEmpty()'   required>";
	echo '<option value="default"></option>';
	echo '</select></p>';
	// # of object per page
	echo "<select id='objectsPerPage' name = 'objectsPerPage'>";
?>
                <option value="10" default <?php   if ($_POST['objectsPerPage'] == 10) { echo selected; } ?> >10 Objects Per Page</option>
                <option value="20" <?php   if ($_POST['objectsPerPage'] == 20) { echo selected; } ?> >20 Objects Per Page</option>
                <option value="30" <?php   if ($_POST['objectsPerPage'] == 30) { echo selected; } ?> >40 Objects Per Page</option>
                <option value="80" <?php   if ($_POST['objectsPerPage'] == 80) { echo selected; } ?> >80 Objects Per Page</option>
<?php 
    echo "</select>";
    echo "<p><input type='search' name='kid' id='gal_searchBox' placeholder='Search:'><button type='submit' id='gal_search' name='k_search' class='blue-btn' >SEARCH</button></p>";

    echo "</form>";
    echo '</div>';
	//echo "<button id='selectAll'>Select All  Objects</button>"
  ?>
  
 <?php 
         /* connect to database*/
    $mysql_hostname = kordat_dbhostname;
    $mysql_user = kordat_dbhostuser;
    $mysql_database = kordat_dbselectname;
    $mysql_password = kordat_dbhostpass;

    @$bd = new mysqli($mysql_hostname, $mysql_user, $mysql_password, $mysql_database);
    if ($bd->connect_error) {
        echo "<p class='error'><strong>";
        echo "Please edit config.php.dist (Kora Host Database Settings) first! Save as config.php!";
        echo "</strong></p>";
    } else {
              if ($_SERVER['REQUEST_METHOD'] == 'POST'){
  ?>

     <div class='kora-objs' id = 'kora-objs'>   
                      
    <?php
    
 //   var_dump($_POST['id_scheme']);
 //   var_dump($_POST['array_control']);
                if (isset($_POST['id_scheme']) && isset($_POST['array_control']) && (isset($_POST['controlsImage']) || isset($_POST['controlsVideo']) || isset($_POST['controlsAudio'])) ) {
                    //get search information
                    $schemeid = $_POST['id_scheme'];
                    $controls = $_POST['array_control'];
                    $dbproj = get_option('kordat_dbproj');
                    $dbscheme = get_option('kordat_dbscheme');
                    $dbtoken = get_option('kordat_dbtoken');
                   // var_dump($controls);
                    
                    $query_sid_pid = "SELECT schemeid,pid FROM scheme WHERE schemeid = '".$schemeid."';";
                    $stmt = $bd->prepare($query_sid_pid) ;
                    $stmt->execute();
                    $stmt->bind_result($sids,$pids);
                    //$sid_pid_token = array();
                        
                    while($stmt->fetch()){
                        $sid = $sids;
                        $pid = $pids;
                        //echo $sid." ".$pid."<br>";
                        if (in_array($sid, $dbscheme) && in_array($pid, $dbproj)){
                            $pos = array_search($pid, $dbproj);
                            $sid_pid_token = array('schemeid' => $sid, 'projectid' => $pid, 'token' => $dbtoken[$pos]);
                           // $val = $sid."-".$pid."-".$dbtoken[$pos];
                            //array_push($sid_pid_token,$val);
                        }
                    }
                    $stmt->close();
                   // var_dump($sid_pid_token);
                    
                    //korasearch
                    
                    $restful = get_option('kordat_dbapi');
			        $restful_url =$restful . KORA_PLUGIN_RESTFUL_SUBPATH;
			
			        //GET image/video/audio filed name 
                    
                    $image_control = $_POST['controlsImage'];
                    $video_control = $_POST['controlsVideo'];
                    $audio_control = $_POST['controlsAudio'];    
                            
			        $i = 0;
			      /*  $fields = "";
			       //$num_option = count($controls);
                    foreach($controls as $option_value) {
                         $fields .= $option_value.',';
                   }
                   if (!in_array("Thumbnail", $controls)) {
                         $fields .= "Thumbnail,";
                    }
                    if (!in_array("Multi-Part Associator", $controls)) {
                         $fields .= "Multi-Part Associator,";
                    }
                    if (!in_array("Image", $controls)) {
                         $fields .= "Image,";
                    }
                    if (!in_array("Audio File", $controls)) {
                         $fields .= "Audio File,";
                    }
                    if (!in_array("Video File", $controls)) {
                         $fields .= "Video File,";
                    }
                    $lastC = substr($fields, -1);
                    if ($lastC == ',') {
                         $fields = trim($fields, ",");
                    } 
                                //var_dump($fields);*/
                    $fields = 'ALL';
                               // $display='plugin';
                    $display = 'json';
                    $query = "";
                    if (isset($_POST['keyword'])) {
                        $k = $_POST['keyword'];
                        if (count($controls) == 1) {
                                $query .= $controls[0].",LIKE,".$k;
                         } else {
                                for ($i = 0; $i < count($controls); $i++) {
                                        if ($i == 0) {
                                            $query .= "(".$controls[$i].",LIKE,".$k.")";
                                        } else {

                                            $query .= ",OR,"."(".$controls[$i].",LIKE,".$k.")";
                                        }
                                }
                         }
                        if (!empty($sid_pid_token)) {
                            $url = $restful_url.'?request=GET&pid='.$sid_pid_token['projectid'].'&sid='.$sid_pid_token['schemeid'].'&token='.$sid_pid_token['token'].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query);
                        }
                    
                    } else {
			                    
                        if (!empty($sid_pid_token)) {
                             $url = $restful_url.'?request=GET&pid='.$sid_pid_token['projectid'].'&sid='.$sid_pid_token['schemeid'].'&token='.$sid_pid_token['token'].'&display='.urlencode($display).'&fields='.urlencode($fields);
                        }
                    }
               
                    //initialize post request to KORA API using curl
                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                    curl_setopt($ch, CURLOPT_USERPWD, $user.':'.$pass);

                    //capture results and display
                    $obj_json = curl_exec($ch);
                    //convert json string to php array
                    $server_output = json_decode($obj_json, true);
                     //var_dump($server_output);   
                     if (is_array($server_output)) {
                     
               $total_obj = count($server_output);
              
               $objectsPerPage = $_POST['objectsPerPage'];
               $totalPages = ceil($total_obj / $objectsPerPage); 
            
               ?>
               <button id="selectAll" align="center" class = "blue-btn" style = "height:54px; width: 300px">Select All <?Php echo $total_obj; ?> Objects</button>
               <button id="prevPage" align="center" class = "prev" style = "height:54px; width: 300px; color:white; background-color: #57abce; border: 1px solid #57abce">PREV</button>
               
               <button id="nextPage" align="center" class = "next" style = "height:54px; width: 300px; color:white; background-color: #57abce; border: 1px solid #57abce">NEXT</button>
               
               <div id="pagination" alt = "<?php echo $total_obj; ?>">
                <?php /*    <a href="#" class="prev">
                    <img id="prevPage" src="images/Arrow%20-%20Pagination%20Left.svg" 
                        width="8" height="15" alt="Previous Page Arrow" />
                    </a>
                    
                    <div id="pageNums" alt = "<?php echo $totalPages; ?>">
                        <input type = 'text' name = 'curPageNum' >
                        <?php 
                            for ($i = 1; $i <= $totalPages; $i++) {
                                 echo '<span id = "pagenum_'.$i.'" >'.$i.'</span>';
                            }
                            
                          //   <span class="active-page">1</span>
                   //     <span>2</span>
                   //     <span>3</span>
                    //    <span>4</span>
                    //    <span>5</span>
                   //     <span>...</span>
                    //    <span>20</span>
                            
                        ?>
                       
                    </div>
                    <a href="#" class="next">
                    <img id="nextPage" src="images/Arrow%20-%20Pagination%20Right.svg" 
                        width="8" height="15" alt="Next Page Arrow" />
                     </a> */ ?>
                </div>  
               
                       
               <?php
                 echo " <span id = 'image_control' style = 'display:none'>".$image_control."</span>
                      <span id = 'video_control' style = 'display:none'>".$video_control."</span>
                      <span id = 'audio_control' style = 'display:none'>".$audio_control."</span>";
                      
                     foreach($server_output as $record) {
                                if ($record[$image_control]) {
                                    $src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/'.$record[$image_control]['localName'];

                                } else if ($record[$video_control]) {
                                    
                                } else if ($record[$audio_control]) {
                                    
                                } else {
                                    $src = "http://img.photobucket.com/albums/v516/MizGrace/babyhedgehoginbubblebath.jpg";
                                }
                                /*   if($record['Image'] || $record['Thumbnail'] ) {
                                       if ($record['Image']) {
                                            $src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/thumbs/'.$record['Image']['localName'];
                                       } else if ($record['Thumbnail']['localName']) {
                                           $src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/thumbs/'.$record['Thumbnail']['localName'];

                                          // $src = getThumbnailKORA($record['Thumbnail']['localName']);
                                       }
                                      
                                   } else if ($record['Audio File'] || $record['Video File']) {
                                       if(!empty($record['Audio File']))
                                        {
                                          //  $audioFile = mysql_escape_string(getFullURLFromFileName($value['Audio File']['localName']));
                                            echo "<br />click play for full interview";
                                        // KoraEmbedMedia(array('kid' => $value['kid'], 'cid' => '28', 'tagid' => 'player', 'width' => '300px', 'height' => '30px', 'autoplay' => 'false'));    
                                         //   KoraEmbedMedia( Array('url' => $audioFile, 'tagid' => 'player', 'width' => '300px', 'height' => '30px',  'autoplay' => 'false') );      
                                        } else if(!empty($record['Video File'])
                                        {
                                            //$videoFile = mysql_escape_string(getFullURLFromFileName($value['Video File']['localName']));
                                            if ($value['Start Time'] != "") {
                                                $ts = timetoseconds($value['Start Time']);
                                                $te = timetoseconds($value['End Time']);
                                            } else {
                                                $ts = null;
                                                $te = null;
                                            }
                                            $dur = $te - $ts;
                                        // echo $dur;
                                            // SANITY CHECK TO SEE IF WE HAVE VALID NUMBERS FOR TS/TE/DUR, WORRIED FOR THE CASE IF KORA SETS TO EMPTY
                                            if (!is_numeric($ts) || !is_numeric($dur))
                                            { $ts = -1; $te = -1; $dur = -1; }

                                            echo "<br />click play for full interview";
                                            
                                        KoraEmbedMedia( Array('url' => $videoFile, 'tagid' => 'player', 'width' => '300px', 'height' => '211px', 'timestart' => $ts, 'duration' => $dur, 'autoplay' => 'false') );
                                        // KoraEmbedMedia(array('kid' => $value['kid'], 'cid' => 27, 'tagid' => 'player', 'width' => '300px', 'height' => '211px', 'timestart' => $ts, 'duration' => $dur, 'autoplay' => 'false'));    
                                        }   
                                   } 
                                   else {
                                       $src = "http://img.photobucket.com/albums/v516/MizGrace/babyhedgehoginbubblebath.jpg";
                                   }*/
        ?>		
		
		<!-- Same as Library page -->

            <?php  /*
		<!--32-131-1-->
			<div class='kora-obj'>
				<div class='kora-obj-left'>
					<img src='http://orig00.deviantart.net/f0ce/f/2011/027/d/5/darth_vader_by_steveargyle-d387h22.jpg' alt='32-131-1'>
					<input type='button' value='edit details' />
				</div>
				<div class='kora-obj-right'>
					<div class='kora-obj-close'>
						<img src='../wp-content/plugins/kora/images/Close - Tiny.svg' class='closePic'>
					</div>
					<ul class='kora-obj-fields'>
						<li><span>KID:</span> 32-131-1</li> 
						<li><span>Field Name:</span> Field Input</li>
						<li><span>Field Name:</span> Field Input</li>
						<li><span>Field Name:</span> Field Input</li>
						<li><span>Field Name:</span> Field Input. Lorem ipsum dolor sit amet, consectetur adipiscing elit, </li>
						<li><span>Field Name:</span> Field Input</li>
					</ul>
				</div>
			</div>
		*/ ?>
            <?php 
                echo "<div class='kora-obj' id = '".$record['kid']."'>
				                            <div class='kora-obj-left'>
					                            <img src='".$src."' alt='".$record['kid']."'>
					                            <input type='button' class = 'edit_detials' id = '".$record['kid']."' value='edit details'  alt = '".$sid_pid_token['schemeid']."'>
				                            </div>
				                            <div class='kora-obj-right'>
					                          
					                            <ul class='kora-obj-fields'>";
                                                 echo '<div id = "edit_details_'.$record['kid'].'">';
						                           echo "<li><span>KID</span>:".$record['kid']."</li>";
                                                     foreach($controls as $field) {
                                                         if (is_array($record[$field])) {
                                                              echo "<li><span>".$field."</span>: ".implode(" ",$record[$field])."</li>";
                                                         } else {
                                                             echo "<li><span>".$field."</span>: ".$record[$field]."</li>";
                                                         }
                                                     }
						                            //<li><span>Field Name:</span> Field Input</li>
                                                    echo '</div>';
					                            echo "</ul>
				                           </div>
			   </div>";  
                     }
               
                   } else {
                        echo "<h1>No matched object records!</h1>";
                   }
                              
                 } else {
                     echo "<h1>Please choosing Scheme and Controls first!</h1>";
                }
             ?>


               		<div id='add-kora-objs'>
			            <input type="submit" value='Add Object(s) to Library' />
		           </div>

    </div>	
<?Php 
              }
     }  
?>

<!-- Modals -->
<div class="remodal" id="deleteObjectModal" data-remodal-id="deleteObjectModal">
	<button data-remodal-action="close" class="remodal-close"></button>

	<h2>Remove this Object?</h2>
	<p>Doing so will remove this object from any gallery it is associated with.</p>

	<button class="remove">Remove</button>
	<button class="cancel">Cancel</button>
</div>


<div class="remodal" id="editObjectModal" data-remodal-id="editObjectModal">
	<button data-remodal-action="close" class="remodal-close"></button>

    <img id="backArrow" src="../wp-content/plugins/kora/images/Arrow%20-%20Left.svg" width="12" height="20" alt="Back Arrow" />
	<h2>Edit Details for Object Name</h2>
    <div class = "object_details">

    </div>
</div>

<script> var url_plugin = '<?php echo KORA_PLUGIN_PATHBASE;?>'; </script>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>
<script src="http://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/js/bootstrap-multiselect.js"></script>


<script src="<?php echo plugins_url('kora/remodal_v1.0.6/dist/remodal.min.js'); ?>"></script>
<script src="<?php echo plugins_url('kora/chosen_v1.4.2/chosen.jquery.min.js'); ?>"></script>
<script src="<?php echo plugins_url('kora/chosen_v1.4.2/chosen.proto.min.js'); ?>"></script>
<link rel="stylesheet" href="http://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/css/bootstrap-multiselect.css" type="text/css"/>
<link rel="stylesheet" href="<?php echo plugins_url('kora/remodal_v1.0.6/dist/remodal.css'); ?>" type="text/css"/>
<link rel="stylesheet" href="<?php echo plugins_url('kora/remodal_v1.0.6/dist/remodal-default-theme.css'); ?>" type="text/css"/>

<link rel="stylesheet" href="<?php echo plugins_url('kora/chosen_v1.4.2/chosen.css?').time(); ?>" type="text/css"/>
<script>

var title='<?php echo $title_form;?>';
//var img_c='<?php echo $image_control;?>';
var desc='<?php echo $desc;?>';
var type='<?php echo $type;?>';

</script>

<script src="<?php echo KORA_PLUGIN_PATHBASE.'js/gallery.js';?>"></script>
