// var chk;
// var query = '';
// var divs = [];

var pdivs = $(".kora_results_container");
var num_obj = pdivs.children().size();
if (num_obj > obj_per_page) {
    if (Math.ceil(num_obj/obj_per_page) < 6) {
        var page_count = Math.ceil(num_obj/obj_per_page);
    } else {
        var page_count = 7;
    }
    var out_list = "<div id='prev' ><img src='../images/Arrow\ -\ Pagination\ Left.svg'/></div>" +
    "<ul id='pages'>"+
        "<li id='page_1' class='current_page'>1</li>";
    if (Math.ceil(num_obj/obj_per_page) > 3) {
        out_list += "<li id='leftEllipses' class='hidden'>...</li>";
    }
    for (var page = 2; page < page_count; page++) {
        out_list += "<li id='page_"+page+"'>"+page+"</li>";
    }
    if (Math.ceil(num_obj/obj_per_page) > 3) {
        out_list += "<li id='rightEllipses'>...</li>";
        out_list += "<li id='page_7' class='page_7'>"+Math.ceil(num_obj/obj_per_page)+"</li>";
    } else if (Math.ceil(num_obj/obj_per_page) >= 2) {
        out_list += "<li id='page_7' class='page_7'>"+Math.ceil(num_obj/obj_per_page)+"</li>";
    }
    out_list += "</ul>"+
    "<div id='next' class='border_arrow'><img src='../images/Arrow\ -\ Pagination\ Right.svg'/></div>";
    $('.pagination_footer').append(out_list);
    var pos = 0;
    if(pos === 0){
        for (var i = pos; i < pos + obj_per_page; i++) {
            $(pdivs).children().eq(i).show();
        }
        for (var i = pos + obj_per_page; i < num_obj; i++) {
            $(pdivs).children().eq(i).hide();
        }
    }
    // click events for pagination
    $('#page_1').click(function() {
        pos = 0;
        $('.current_page').removeClass('current_page');
        $(this).addClass('current_page');
        $('#prev').removeClass('border_arrow');
        $('#next').addClass('border_arrow');
        $('#leftEllipses').addClass('hidden');
        $('#rightEllipses').removeClass('hidden');
        $('#page_2').text('2');
        $('#page_3').text('3');
        $('#page_4').text('4');
        $('#page_5').text('5');
        $('#page_6').text('6');
        for (var i = pos; i < pos + obj_per_page; i++) {
            $(pdivs).children().eq(i).show();
        }
        for (var i = 0; i < pos; i++) {
            $(pdivs).children().eq(i).hide();
        }
    });
    for (var page = 2; page < page_count; page++) {
        $('#page_'+page).click(function() {
            $('.current_page').removeClass('current_page');
            if ($(this).attr('id') !== 'page_4') {
                // if ($(this).text() <) {
                //
                // }
            } else {
                pos = ($(this).text()-1)*obj_per_page;
            }
            $(this).addClass('current_page');
            $('#prev').addClass('border_arrow');
            $('#next').addClass('border_arrow');
            for (var i = 0; i < pos; i++) {
                $(pdivs).children().eq(i).hide();
            }
            for (var i = pos; i < pos + obj_per_page; i++) {
                $(pdivs).children().eq(i).show();
            }
            for (var i = pos + obj_per_page; i < num_obj; i++) {
                $(pdivs).children().eq(i).hide();
            }
        });
    }
    $('#prev').click(function(){
        if ( pos >= 0 + obj_per_page){
            $(this).addClass('border_arrow');
            $('#next').addClass('border_arrow');
            if (Math.ceil(num_obj/obj_per_page) > 6) {
                if (pos > (num_obj - obj_per_page*3)) { // right three
                    current_page_id = $('.current_page').attr('id');
                    current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))-1;
                    $('.current_page').removeClass('current_page');
                    $('#page_'+current_page_number).addClass('current_page');

                } else if (pos < obj_per_page*3) { // left three
                    current_page_id = $('.current_page').attr('id');
                    current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))-1;
                    $('.current_page').removeClass('current_page');
                    $('#page_'+current_page_number).addClass('current_page');
                } else { // The rest
                    $('#rightEllipses').removeClass('hidden');
                    for (var page = 2; page < page_count; page++) {
                        $('#page_'+page).text(parseInt($('#page_'+page).text())-1);
                    }
                    // current_page_id = $('.current_page').attr('id');
                    // current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))-1;
                    // if (current_page_number === Math.ceil(num_obj/obj_per_page)) {
                    //     $('.current_page').removeClass('current_page');
                    //     $('#page_7').addClass('current_page');
                    // }
                }
            } else {
                if ($('.current_page').prev().attr('id') == 'page_1') {
                    $('.current_page').removeClass('current_page');
                    $('#page_1').addClass('current_page');
                } else {
                    current_page_id = $('.current_page').attr('id');
                    if (current_page_id === 'page_7') {
                        current_page_number = Math.ceil(num_obj/obj_per_page)-1;
                    } else {
                        current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))-1;
                    }
                    $('.current_page').removeClass('current_page');
                    $('#page_'+current_page_number).addClass('current_page');
                }
            }
            var hide_end = pos + obj_per_page;
            for (var i = pos; i < hide_end; i++) {
                $(pdivs).children().eq(i).hide();
            }
            pos = pos - obj_per_page;
            var show_end = pos + obj_per_page;
            for (var i = pos; i < show_end; i++) {
                $(pdivs).children().eq(i).show();
            }
        }
        if (pos === 0) {
            $(this).removeClass('border_arrow');
            $('.current_page').removeClass('current_page');
            $('#page_1').addClass('current_page');
        }
    });
    $('#next').click(function(){
        if ( pos < num_obj - obj_per_page) {
            $(this).addClass('border_arrow');
            $('#prev').addClass('border_arrow');
            if (Math.ceil(num_obj/obj_per_page) > 6) {
                if (pos < obj_per_page*3) { // left three
                    current_page_id = $('.current_page').attr('id');
                    current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))+1;
                    $('.current_page').removeClass('current_page');
                    $('#page_'+current_page_number).addClass('current_page');

                } else if (pos > (num_obj - obj_per_page*4) && (pos != num_obj)) { // right three
                    current_page_id = $('.current_page').attr('id');
                    current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))+1;
                    $('.current_page').removeClass('current_page');
                    $('#page_'+current_page_number).addClass('current_page');
                    $('#rightEllipses').addClass('hidden');
                } else { // The rest
                    $('#leftEllipses').removeClass('hidden');
                    for (var page = 2; page < page_count; page++) {
                        $('#page_'+page).text(parseInt($('#page_'+page).text())+1);
                    }
                }
            } else {
                if ($('.current_page').next().attr('id') === 'page_7') {
                    $('.current_page').removeClass('current_page');
                    $('#page_7').addClass('current_page');
                } else {
                    current_page_id = $('.current_page').attr('id');
                    current_page_number = parseInt(current_page_id.substr(current_page_id.length - 1))+1;
                    $('.current_page').removeClass('current_page');
                    $('#page_'+current_page_number).addClass('current_page');
                }
            }
            var hide_end = pos + obj_per_page;
            for (var i = pos; i < hide_end; i++) {
                $(pdivs).children().eq(i).hide();
            }
            pos += obj_per_page;
            var show_end = hide_end + obj_per_page;
            for (var i = pos; i < show_end; i++) {
                $(pdivs).children().eq(i).show();
            }
        }
        if (pos + obj_per_page >= num_obj) {
            $(this).removeClass('border_arrow');
        }
    });
    $('#page_7').click(function() {
        $('#next').removeClass('border_arrow');
        $('#prev').addClass('border_arrow');
        $('.current_page').removeClass('current_page');
        $(this).addClass('current_page');
        if (Math.ceil(num_obj/obj_per_page) > 3) {
            $('#rightEllipses').addClass('hidden');
            $('#leftEllipses').removeClass('hidden');
            var current_page_number = Math.ceil(num_obj/obj_per_page);
            $('#page_2').text(current_page_number - 5);
            $('#page_3').text(current_page_number - 4);
            $('#page_4').text(current_page_number - 3);
            $('#page_5').text(current_page_number - 2);
            $('#page_6').text(current_page_number - 1);
        }
        var hide_end = pos + obj_per_page;
        for (var i = pos; i < hide_end; i++) {
            $(pdivs).children().eq(i).hide();
        }
        pos = obj_per_page * Math.floor(num_obj/obj_per_page);
        var show_end = pos + obj_per_page;
        for (var i = pos; i < show_end; i++) {
            $(pdivs).children().eq(i).show();
        }
    });
}

// //search process bar
// $('#submit_serach').click(function() {
//   if (!$('#select_all_scheme').is(':checked')) {
//     // add loading image to div
//     $('#loading').html('<img src="http://preloaders.net/preloaders/287/Filling%20broken%20ring.gif"> loading...');
//     // run ajax request
//     $.ajax({
//       //type: "GET",
//       // dataType: "json",
//       // url: "https://api.github.com/users/jveldboom",
//       success: function(d) {
//         // replace div's content with returned data
//         // $('#loading').html('<img src="'+d.avatar_url+'"><br>'+d.login);
//         // setTimeout added to show loading
//         setTimeout(function() {
//           // $('#loading').html('<img src="' + d.avatar_url + '"><br>' + d.login);
//         }, 2000);
//       }
//     });
//   }
// });

var koraObjectCount = $('.kora-obj').length; // number of kora objects in search
var selectedCount = 0;
var select_all_search = $('#select_all_search');
var select_all_scheme = $('#select_all_scheme');

var setSelectAllCount = function() {
	$('.select_all_btn').text("Select All " + koraObjectCount + " Object(s)");
};
setSelectAllCount();

var insertShortcodeButton = function() {
	if (selectedCount == 0) {
		$('#selected-kora-objs > input').val('');
		$('#selected-kora-objs').removeClass('slide-selected-objs');
	}
	else {
		$('#selected-kora-objs > input').val(selectedCount + ' object(s) selected // add new object(s)?');
		$('#selected-kora-objs').addClass('slide-selected-objs');
	}
}

$('.kora-obj').click(function() {
	$(this).toggleClass('kora-obj-active');
	if($(this).hasClass('kora-obj-active')) {
		selectedCount++;
		if (selectedCount === koraObjectCount) {
			select_all_search.prop('checked', true);
		}
	}
	else {
		selectedCount--;
		if (selectedCount === 0) {
			select_all_search.prop('checked', false);
		}
	}
	insertShortcodeButton();
});

select_all_search.change(function() {
	if(select_all_search.is(':checked')) {
		$('.kora-obj').addClass('kora-obj-active');
		selectedCount = koraObjectCount;
	}
	else {
		$('.kora-obj').removeClass('kora-obj-active');
		selectedCount = 0;
	}
	insertShortcodeButton();
});

$('#insert_shortcode_new').click(function(){
	// if ($('#select_all_scheme').is(':checked')) {
  //   var first = $(divs).first();
  //   chk = "ALL";
  //   $.ajax({
  //     type: "GET",
  //     async: false,
  //     url: url_plugin + "/ajax/insert_library.php",
  //     cache: false,
  //     data: {
  //       "chk": chk
  //     },
  //     success: function(data) {
	//
  //     }
  //   });
  //   chk = first.attr('id');
  //   chk += "-ALL";
  //   query += "(kid,!=," + chk + ")";
  // } else {
  //   $(divs).each(function() {
  //     chk = $(this).attr('id');
  //     $.ajax({
  //       type: "GET",
  //       async: false,
  //       url: url_plugin + "/ajax/insert_library.php",
  //       cache: false,
  //       data: {
  //         "chk": chk
  //       },
  //       success: function(data) {
	//
  //       }
  //     });
	//
  //     if (i == 0 && divs.length == 1 && type == "image") {
  //       query = chk;
  //     } else if (i == 0 && divs.length == 1) {
  //       query = chk;
  //     } else if (divs.length > 1 && i == 0) {
  //       query = "(kid,=," + chk + ")";
  //       i++;
  //     } else if (divs.length > 1 && i < divs.length) {
  //       query += ",or,(kid,=," + chk + ")";
  //       i++;
  //     }
  //   });
  // }
  // var sid = $('#id_scheme option:selected').val();
  // //var field = "";
  // var controlsOnly = controls.substring(1, controls.length - 1);
  // //var controlArray = controlsOnly.split(",");
  // /*for (var i=0; i < controlArray.length; i++) {
  //    fields += controlArray[i];
  // }*/
  // var field = controlsOnly;
  // desc = controlsOnly;
  // //var fields = fields.replace(/"/g,'');
		var title_control = document.getElementById("title_control").value;
		var desc_control = document.getElementById("desc_control").value;
		var img_control = document.getElementById("img_control").value;
		var audio_control = document.getElementById("audio_control").value;
		var video_control = document.getElementById("video_control").value;
		var type = jQuery("input[name='type']:checked").val(); // pagination or infscroll
		var pagesize = 5;
		if ($('#pic_pagesize').val() != '') {
			pagesize = $('#pic_pagesize').val();
		}
		var i = 0;
		var num_selected = $('.kora-obj-active').length;
    var sid = $('#id_scheme option:selected').val();
		var query;
		$('.kora-obj-active').each(function() {
		  var chk = $(this).attr('id'); // kora objects should have KID as their id attribute
		  if (i == 0 && num_selected == 1 && type == "image") {
				// Type = 'image' will never occur. Type would be 'pagination' or 'scroll'.
				// What should be done with this?
		    query = chk;
		  }
			else if (i == 0 && num_selected == 1) {
		    query = "kid,=," + chk;
		  }
			else if (num_selected > 1 && i == 0) {
		    query = "(kid,=," + chk + ")";
		    i++;
		  }
			else if (num_selected > 1 && i < num_selected) {
		    query += ",or,(kid,=," + chk + ")";
		    i++;
		  };
		});
		if ($('#add_details').is(':checked')) {
			var shortcode =
					"[KORAGALLERY KG_TYPE= '" + type +
    			"' KG_IMAGECONTROL= '" + img_control +
    			"' KG_AUDIOCONTROL= '" + audio_control +
    			"' KG_VIDEOCONTROL= '" + video_control +
    			"' KG_TITLECONTROL= '" + title_control +
    			"' KG_DESCCONTROL= '" + desc_control +
    			"' KG_LINKBASE='" + detailslink + //detailslink is declared at end of postlibrary.php
    			"' KGIS_PAGESIZE='" + pagesize +
          "' SID = '" + sid +
    			"' QUERY= '" + query +
    			"'][/KORAGALLERY]";
		}
		else {
			var shortcode =
				"[KORAGALLERY KG_TYPE= '" + type +
				"' KG_IMAGECONTROL= '" + img_control +
				"' KG_AUDIOCONTROL= '" + audio_control +
				"' KG_VIDEOCONTROL= '" + video_control +
				"' KG_TITLECONTROL= '" + title_control +
				"' KG_DESCCONTROL= '" + desc_control +
				"' KGIS_PAGESIZE='" + pagesize +
        "' SID = '" + sid +
				"' QUERY= '" + query +
				"'][/KORAGALLERY]";
		}

		var win = window.dialogArguments || opener || parent || top;
		win.send_to_editor(shortcode);
});
