<?php
	require_once("../../../../wp-blog-header.php");
	require_once( realpath( dirname(__FILE__) . "/../dbconfig.php" ) );
	global $wpdb;
	//echo "teststarfafsa";
	if(isset($_GET['chk']) && isset($_GET['schemeid']) && isset($_GET['controlfileds']) ){
		$schemeid = $_GET['schemeid'];
		$controlfileds  = $_GET['controlfileds'];
        $chkarr = $_GET['chk'];
	    $kid = $chkarr[0];
	    $gallery = $chkarr[1];
		$description = $chkarr[2];
	//	echo $gallery."11111";
		
		//insert record into gallery information db.
		$gallery_name = $wpdb->prefix . $gallery;
		$gallert_infodb = $wpdb->dbname;
		$query_galleryinfo = "SHOW TABLES $gallert_infodb LIKE $gallery_name";
		//$wpdb->get_results($query);
		//if ($wpdb->num_rows == 0 ){
	//		echo "1322222222222222222223::::".$wpdb->get_var(query_galleryinfo); 
		if($wpdb->get_var($query_galleryinfo) != $gallery_name) {
		//if(empty($wpdb->get_results($query))){   
		 	$query_create_table = "CREATE TABLE $gallery_name (
					id mediumint(9) NOT NULL AUTO_INCREMENT PRIMARY KEY,
					KID VARCHAR(45) NOT NULL,
					url VARCHAR(10000) DEFAULT '' NOT NULL,
					thumb VARCHAR(10000) DEFAULT '' NOT NULL,
					title VARCHAR(999) NOT NULL
					);";
			$wpdb->query($query_create_table);
			$galleryinfo = $wpdb->prefix . "koragallery";
			   //insert galery information into wp_koragallery
                if ($description) {
                    $gallery_description = $description;
                } else {
                    $gallery_description = "No description";
                }
			if (!$wpdb->query("select description from $galleryinfo")) {
				$wpdb->query("ALTER TABLE $galleryinfo ADD COLUMN `description` VARCHAR(1000)");
			}
			$query_galleryinfo_check = "SELECT * FROM $galleryinfo where title LIKE '$gallery'";
		    if(empty($wpdb->get_results($query_galleryinfo_check))){
			    $wpdb->insert(
					$wpdb->prefix . "koragallery",
					array(
						"title" => $gallery,
						"description" => $gallery_description
					),
					array(
						'%s',
						'%s'
					) 
				);
			}

		 }
		 
		 //check if object is already in gallery
		$query = "SELECT * FROM $gallery_name where KID= '$kid'";
	    if(empty($wpdb->get_results($query))){
					// connect to database
				$mysql_hostname = kordat_dbhostname;
				$mysql_user = kordat_dbhostuser;
				$mysql_database = kordat_dbselectname;
				$mysql_password = kordat_dbhostpass;
				$bd = new mysqli($mysql_hostname, $mysql_user, $mysql_password, $mysql_database);
				if ($bd->connect_error) {
					die("Connection failed: " . $bd->connect_error);
				}
			    $dbproj = get_option('kordat_dbproj');
				$dbscheme = get_option('kordat_dbscheme');
				$dbtoken = get_option('kordat_dbtoken');
			   
                    $query_sid_pid = "SELECT schemeid,pid FROM scheme WHERE schemeid = '".$schemeid."';";
                    $stmt = $bd->prepare($query_sid_pid) ;
                    $stmt->execute();
                    $stmt->bind_result($sids,$pids);
                    //$sid_pid_token = array();
                        
                    while($stmt->fetch()){
                        $sid = $sids;
                        $pid = $pids;
                        //echo $sid." ".$pid."<br>";
                        if (in_array($sid, $dbscheme) && in_array($pid, $dbproj)){
                            $pos = array_search($pid, $dbproj);
                            $sid_pid_token = array('schemeid' => $sid, 'projectid' => $pid, 'token' => $dbtoken[$pos]);
                           // $val = $sid."-".$pid."-".$dbtoken[$pos];
                            //array_push($sid_pid_token,$val);
                        }
                    }
                    $stmt->close();
        
			$user = kordat_dbuser;
			//$pass = get_option('kordat_dbpass');
			$pass = kordat_dbpass;
			//$query = "KID,=,".$kid;
			if ($kid == "ALL") {
				$query = "Display,=,"."True";
			} else {
				$query = "KID,=,".$kid;
			}
			$restful_url = get_option('kordat_dbapi') . KORA_PLUGIN_RESTFUL_SUBPATH;
			$fields = 'ALL';
			$display='json';
			
             if (!empty($sid_pid_token)) {
                  $url = $restful_url.'?request=GET&pid='.$sid_pid_token['projectid'].'&sid='.$sid_pid_token['schemeid'].'&token='.$sid_pid_token['token'].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query);
             }
				
              //initialize post request to KORA API using curl
              $ch = curl_init($url);
              curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
              curl_setopt($ch, CURLOPT_USERPWD, $user.':'.$pass);

              //capture results and display
              $obj_json = curl_exec($ch);
              //convert json string to php array
              $server_output = json_decode($obj_json, true);
			  echo $server_output;
             
			  $control_save = array();
              $control_format = array();
              foreach($server_output as $record){
                    if ($record['Image']['localName']) {
                         $thumb_src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/thumbs/'.$record['Image']['localName'];
                    } else if ($record['Thumbnail']['localName']) {
                         $thumb_src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/thumbs/'.$record['Thumbnail']['localName'];
                    }
                   
                    $src = str_replace("thumbs/", "", $thumb_src);
                                    
                    //Get KID from HTML
                    $kid = $record['kid'];
                    $title = $record['Title'];
                   
                    //get all controls need to save in db.
            
                    if (is_array($controlfileds) ) {
                                $i = 0;
                        foreach($controlfileds as $control) {
                            $i = $i + 1;
                            
                            if ($i != 1) {
                                if ($control == "KID") {
                                     $control_save['KID'] = $record['kid'];
                                } else {
                                    if (is_array($record[$control])) {
                                         $control_save[$control] = implode(" ",$record[$control]);
                                    } else {
                                         $control_save[$control] = $record[$control];    
                                    }
                                    
                                }
                               $control_format[] = '%s';
                            } 
                        }
                    } 
              }
              $control_save['schemeid'] = $schemeid;
              $control_format[] = '%s';
              $control_save['url'] = $src;
              $control_format[] = '%s';
              $control_save['thumb'] = $thumb_src;
              $control_format[] = '%s';
			  echo $control_save['schemeid'];
			  echo $gallery_name;
			//  $query_key = "SELECT $key FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = $gallert_infodb AND TABLE_NAME = $gallery_name;"
//select $key from $gallery_name
			  foreach ($control_save as $key => $value) {
                  if (!$wpdb->query("select $key from $gallery_name")) {
					  echo "1111111::" . $wpdb->query("select $key from $gallery_name");
                      $wpdb->query("ALTER TABLE $gallery_name ADD COLUMN `$key` VARCHAR(1000) NOT NULL DEFAULT 'not display' ");
                      echo json_encode($key);    
                  }
             }
           $wpdb->insert($gallery_name, $control_save,  $control_format);

			//	$wpdb->insert(
			//		$gallery_name,
			//		array(
			//			'KID' => $kid,
			//			'url' => "$src",
			//			'title' => $title,
			//			'thumb' => $thumb_src
			//		),
			//		array(
			//			'%s',
			//			'%s',
			//			'%s',
			//			'%s'
			//		)
			//	);
			/*	header('HTTP/1.1 200 OK');*/
				echo json_encode (true);
			}
			else{
				header('HTTP/1.1 200 OK');
				echo json_encode(false);

			}
			
		/*	if(empty($wpdb->get_results($query))){
					// connect to database
				$mysql_hostname = kordat_dbhostname;
				$mysql_user = kordat_dbhostuser;
				$mysql_database = kordat_dbselectname;
				$mysql_password = kordat_dbhostpass;
				$bd = new mysqli($mysql_hostname, $mysql_user, $mysql_password, $mysql_database);
				if ($bd->connect_error) {
					die("Connection failed: " . $bd->connect_error);
				}
			    $dbproj = get_option('kordat_dbproj');
				$dbscheme = get_option('kordat_dbscheme');
				$dbtoken = get_option('kordat_dbtoken');
			   
                    $query_sid_pid = "SELECT schemeid,pid FROM scheme WHERE schemeid = '".$schemeid."';";
                    $stmt = $bd->prepare($query_sid_pid) ;
                    $stmt->execute();
                    $stmt->bind_result($sids,$pids);
                    //$sid_pid_token = array();
                        
                    while($stmt->fetch()){
                        $sid = $sids;
                        $pid = $pids;
                        //echo $sid." ".$pid."<br>";
                        if (in_array($sid, $dbscheme) && in_array($pid, $dbproj)){
                            $pos = array_search($pid, $dbproj);
                            $sid_pid_token = array('schemeid' => $sid, 'projectid' => $pid, 'token' => $dbtoken[$pos]);
                           // $val = $sid."-".$pid."-".$dbtoken[$pos];
                            //array_push($sid_pid_token,$val);
                        }
                    }
                    $stmt->close();
        
			$user = kordat_dbuser;
			//$pass = get_option('kordat_dbpass');
			$pass = kordat_dbpass;
			//$query = "KID,=,".$kid;
			if ($kid == "ALL") {
				$query = "Display,=,"."True";
			} else {
				$query = "KID,=,".$kid;
			}
			$restful_url = get_option('kordat_dbapi') . KORA_PLUGIN_RESTFUL_SUBPATH;
			$fields = 'ALL';
			$display='json';
			
             if (!empty($sid_pid_token)) {
                  $url = $restful_url.'?request=GET&pid='.$sid_pid_token['projectid'].'&sid='.$sid_pid_token['schemeid'].'&token='.$sid_pid_token['token'].'&display='.urlencode($display).'&fields='.urlencode($fields).'&query='.urlencode($query);
             }
				
              //initialize post request to KORA API using curl
              $ch = curl_init($url);
              curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
              curl_setopt($ch, CURLOPT_USERPWD, $user.':'.$pass);

              //capture results and display
              $obj_json = curl_exec($ch);
              //convert json string to php array
              $server_output = json_decode($obj_json, true);
             
			  $control_save = array();
              $control_format = array();
              foreach($server_output as $record){
                    if ($record['Image']['localName']) {
                         $thumb_src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/thumbs/'.$record['Image']['localName'];
                    } else if ($record['Thumbnail']['localName']) {
                         $thumb_src = get_option('kordat_dbapi').'files/'.$sid_pid_token['projectid'].'/'.$sid_pid_token['schemeid'].'/thumbs/'.$record['Thumbnail']['localName'];
                    }
                   
                    $src = str_replace("thumbs/", "", $thumb_src);
                                    
                    //Get KID from HTML
                    $kid = $record['kid'];
                    $title = $record['Title'];
                   
                    //get all controls need to save in db.
            
                    if (is_array($controlfileds) ) {
                                $i = 0;
                        foreach($controlfileds as $control) {
                            $i = $i + 1;
                            
                            if ($i != 1) {
                                if ($control == "KID") {
                                     $control_save['KID'] = $record['kid'];
                                } else {
                                    if (is_array($record[$control])) {
                                         $control_save[$control] = implode(" ",$record[$control]);
                                    } else {
                                         $control_save[$control] = $record[$control];    
                                    }
                                    
                                }
                               $control_format[] = '%s';
                            } 
                        }
                    } 
              }
              $control_save['schemeid'] = $schemeid;
              $control_format[] = '%s';
              $control_save['url'] = $src;
              $control_format[] = '%s';
              $control_save['thumb'] = $thumb_src;
              $control_format[] = '%s';
			  foreach ($control_save as $key => $value) {
                  if (!$wpdb->query("select $key from $gallery_name")) {
                      $wpdb->query("ALTER TABLE $gallery_name ADD COLUMN `$key` VARCHAR(1000) NOT NULL DEFAULT 'not display' ");
                      echo json_encode($key);    
                  }
             }
             $wpdb->insert($gallery_name, $control_save,  $control_format);

			//	$wpdb->insert(
			//		$gallery_name,
			//		array(
			//			'KID' => $kid,
			//			'url' => "$src",
			//			'title' => $title,
			//			'thumb' => $thumb_src
			//		),
			//		array(
			//			'%s',
			//			'%s',
			//			'%s',
			//			'%s'
			//		)
			//	);
				header('HTTP/1.1 200 OK');
				echo json_encode (true);
			}
			else{
				header('HTTP/1.1 200 OK');
				echo json_encode(false);

			}*/
	
	}
?>

